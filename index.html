<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اسکنر بهترین IP برای Fastly</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .progress-bar-inner {
            transition: width 0.3s ease-in-out;
        }
        .table-row-appear, .welcome-modal-content {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        /* ===== Welcome Modal Styles Start ===== */
        .welcome-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .welcome-modal-content {
            position: relative;
            text-align: center;
            padding: 2rem;
            max-width: 90%;
            width: 400px;
        }
        .welcome-modal-close {
            position: absolute;
            top: 10px;
            left: 20px; /* Changed from right to left for RTL */
            background: none;
            border: none;
            font-size: 2rem;
            color: #9ca3af;
            cursor: pointer;
            line-height: 1;
        }
        .welcome-modal-close:hover {
            color: #e5e7eb;
        }
        .welcome-modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #fff;
            margin-top: 1rem;
            text-transform: uppercase;
        }
        .welcome-modal-text {
            color: #d1d5db;
            margin-top: 0.5rem;
            font-size: 1.1rem;
        }
        /* ===== Welcome Modal Styles End ===== */
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- ===== Welcome Modal Start ===== -->
    <div id="welcomeModal" class="welcome-modal-overlay hidden">
        <div class="welcome-modal-content glass-effect rounded-2xl">
            <button id="closeWelcomeModal" class="welcome-modal-close">&times;</button>
            <img src="https://i.postimg.cc/Ss5JkZ40/IMG-20250818-154557-613.jpg" alt="Welcome Piggy" class="w-32 h-32 rounded-full mx-auto border-4 border-cyan-500/50 shadow-lg">
            <h2 class="welcome-modal-title">Welcome to Piggy Scanner</h2>
            <p class="welcome-modal-text">لطفا هنگام تست، فیلترشکن خود را خاموش کنید.</p>
        </div>
    </div>
    <!-- ===== Welcome Modal End ===== -->

    <div class="container mx-auto px-4 py-8 min-h-screen flex flex-col items-center">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
                🚀 اسکنر بهترین IP <span class="text-cyan-400">Fastly</span>
            </h1>
            <p class="text-gray-400">پیدا کردن سریع‌ترین IP بر اساس تأخیر (Latency) برای اتصال شما</p>
        </header>

        <!-- Control Panel -->
        <div class="w-full max-w-4xl glass-effect rounded-2xl p-6 mb-8 shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                <!-- IP Range Selection -->
                <div>
                    <label for="ipRangeSelect" class="block mb-2 text-sm font-medium text-white">رنج IP مورد نظر را انتخاب کنید:</label>
                    <select id="ipRangeSelect" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                        <option selected value="">-- یک گزینه را انتخاب کنید --</option>
                        <option value="all">اسکن تمام رنج‌ها</option>
                        <!-- Options will be populated by JavaScript -->
                    </select>
                    <p id="errorText" class="text-red-400 text-sm mt-2 hidden"></p>
                </div>
                <!-- Start Button -->
                <div class="text-center md:text-left">
                     <p class="text-gray-400 text-sm mb-2 md:mb-0 md:hidden">برای شروع فرآیند، روی دکمه کلیک کنید.</p>
                    <button id="startButton" class="w-full md:w-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                        شروع اسکن
                    </button>
                </div>
            </div>
            
            <!-- Progress Bar and Status -->
            <div id="progressContainer" class="mt-6 hidden pt-6 border-t border-gray-700/50">
                <div class="flex justify-between mb-1">
                    <span id="statusText" class="text-base font-medium text-cyan-400">در حال آماده‌سازی...</span>
                    <span id="progressPercentage" class="text-sm font-medium text-white">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-cyan-500 h-2.5 rounded-full progress-bar-inner" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="w-full max-w-4xl">
            <h3 class="text-2xl font-semibold text-white mb-4 text-center">نتایج برتر</h3>
            <div class="glass-effect rounded-2xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-cyan-400 uppercase bg-gray-800/50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-center">رتبه</th>
                                <th scope="col" class="px-6 py-3">آدرس IP</th>
                                <th scope="col" class="px-6 py-3 text-center">زمان تأخیر (ms)</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                           <tr>
                                <td colspan="3" class="text-center py-12 text-gray-500">
                                    برای مشاهده نتایج، یک رنج انتخاب کرده و اسکن را شروع کنید.
                                </td>
                           </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
         <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>ساخته شده توسط piggyteam</p>
        </footer>
    </div>

    <script>
        // --- DOM Elements ---
        const startButton = document.getElementById('startButton');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const statusText = document.getElementById('statusText');
        const resultsBody = document.getElementById('resultsBody');
        const ipRangeSelect = document.getElementById('ipRangeSelect');
        const errorText = document.getElementById('errorText');
        const welcomeModal = document.getElementById('welcomeModal');
        const closeWelcomeModal = document.getElementById('closeWelcomeModal');

        // --- Data ---
        const fastlyIpRanges = [
            "199.232.0.0/16",
            "199.27.72.0/21",
            "104.156.80.0/20",
            "151.101.0.0/16",
            "23.235.32.0/20"
        ];
        
        // --- Functions ---

        /**
         * Populates the IP range select dropdown dynamically.
         */
        function populateIpRanges() {
            fastlyIpRanges.forEach(range => {
                const option = document.createElement('option');
                option.value = range;
                option.textContent = range;
                ipRangeSelect.appendChild(option);
            });
        }

        /**
         * Generates a list of random IPs from a given CIDR range.
         */
        function generateIpsFromCidr(cidr, count) {
            try {
                let [ip, mask] = cidr.split('/');
                mask = parseInt(mask, 10);
                if (isNaN(mask) || mask < 0 || mask > 32) {
                    throw new Error("Invalid CIDR mask.");
                }
                let start = ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;
                let numHosts = 1 << (32 - mask);
                let end = start + numHosts - 1;
                
                const maxCount = Math.min(count, numHosts);
                
                let ips = new Set();
                let attempts = 0;
                while (ips.size < maxCount && attempts < maxCount * 3) {
                    let randomIpNum = Math.floor(Math.random() * (end - start + 1)) + start;
                    let ipStr = [
                        (randomIpNum >> 24) & 255, (randomIpNum >> 16) & 255,
                        (randomIpNum >> 8) & 255, randomIpNum & 255
                    ].join('.');
                    ips.add(ipStr);
                    attempts++;
                }
                return Array.from(ips);
            } catch (error) {
                console.error(`Failed to generate IPs for CIDR ${cidr}:`, error);
                return [];
            }
        }

        /**
         * Measures latency from the client to a specific IP address using the fetch API.
         */
        function measureLatency(ip) {
            const controller = new AbortController();
            const signal = controller.signal;
            const timeout = 2000;

            const fetchPromise = new Promise(async (resolve) => {
                const startTime = performance.now();
                try {
                    await fetch(`https://${ip}/.well-known/traffic-advice`, {
                        method: 'GET',
                        mode: 'no-cors',
                        signal: signal,
                        cache: 'no-store'
                    });
                } catch (e) {
                    // Errors are expected.
                } finally {
                    const endTime = performance.now();
                    resolve(Math.round(endTime - startTime));
                }
            });

            const timeoutPromise = new Promise(resolve => {
                setTimeout(() => {
                    controller.abort();
                    resolve(timeout);
                }, timeout);
            });

            return Promise.race([fetchPromise, timeoutPromise]);
        }

        /**
         * Displays the sorted results in the table.
         */
        function displayResults(results) {
            resultsBody.innerHTML = '';
            if (results.length === 0) {
                resultsBody.innerHTML = `<tr><td colspan="3" class="text-center py-12 text-gray-500">هیچ IP قابل دسترسی در این رنج یافت نشد.</td></tr>`;
                return;
            }

            results.slice(0, 50).forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = 'bg-gray-800/30 border-b border-gray-700/50 hover:bg-gray-700/50 table-row-appear';
                row.style.animationDelay = `${index * 0.03}s`;

                row.innerHTML = `
                    <td class="px-6 py-4 text-center font-medium">${index + 1}</td>
                    <td class="px-6 py-4 font-mono text-white">${result.ip}</td>
                    <td class="px-6 py-4 text-center text-cyan-400 font-semibold">${result.latency}</td>
                `;
                resultsBody.appendChild(row);
            });
        }

        /**
         * Main function to start the scanning process.
         */
        async function startScan() {
            const selectedRange = ipRangeSelect.value;

            if (!selectedRange) {
                errorText.textContent = 'لطفاً یک رنج IP برای اسکن انتخاب کنید.';
                errorText.classList.remove('hidden');
                return;
            }
            errorText.classList.add('hidden');

            startButton.disabled = true;
            startButton.textContent = 'در حال اسکن...';
            startButton.classList.add('opacity-50', 'cursor-not-allowed');
            ipRangeSelect.disabled = true;
            resultsBody.innerHTML = `<tr><td colspan="3" class="text-center py-12 text-gray-400 animate-pulse">در حال آماده‌سازی و تست تأخیر...</td></tr>`;
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressPercentage.textContent = '0%';
            
            statusText.textContent = 'در حال تولید لیست IP...';
            let rangesToScan = selectedRange === 'all' ? fastlyIpRanges : [selectedRange];
            
            let allIps = [];
            rangesToScan.forEach(range => {
                const count = selectedRange === 'all' ? 20 : 100;
                allIps.push(...generateIpsFromCidr(range, count));
            });
            allIps = [...new Set(allIps)];

            if (allIps.length === 0) {
                statusText.textContent = 'خطا در تولید IP!';
                resultsBody.innerHTML = `<tr><td colspan="3" class="text-center py-12 text-red-400">خطایی در تولید لیست IP رخ داد. لطفاً رنج دیگری را امتحان کنید.</td></tr>`;
                resetUI();
                return;
            }

            const totalIps = allIps.length;
            let allResults = [];
            statusText.textContent = `شروع تست ${totalIps} آدرس IP...`;

            const batchSize = 10;
            for (let i = 0; i < totalIps; i += batchSize) {
                const batch = allIps.slice(i, i + batchSize);
                statusText.textContent = `درحال تست: ${batch[0]} ...`;

                const promises = batch.map(ip => measureLatency(ip).then(latency => ({ ip, latency })));
                const batchResults = await Promise.all(promises);
                
                const validResults = batchResults.filter(r => r.latency < 2000);
                allResults.push(...validResults);

                allResults.sort((a, b) => a.latency - b.latency);
                displayResults(allResults);
                
                const completedCount = Math.min(i + batchSize, totalIps);
                const percentage = Math.round((completedCount / totalIps) * 100);
                progressBar.style.width = `${percentage}%`;
                progressPercentage.textContent = `${percentage}%`;
            }

            statusText.textContent = 'اسکن کامل شد!';
            resetUI();
        }

        /**
         * Resets the UI to its initial state after a scan.
         */
        function resetUI() {
            startButton.disabled = false;
            startButton.textContent = 'شروع مجدد اسکن';
            startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            ipRangeSelect.disabled = false;
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', startScan);
        
        // --- Welcome Modal Logic ---
        function showWelcomeModal() {
             welcomeModal.classList.remove('hidden');
        }

        function hideWelcomeModal() {
            welcomeModal.classList.add('hidden');
        }

        closeWelcomeModal.addEventListener('click', hideWelcomeModal);
        welcomeModal.addEventListener('click', (event) => {
            // Close if clicked on the overlay itself, not the content
            if (event.target === welcomeModal) {
                hideWelcomeModal();
            }
        });

        // Populate the dropdown and show modal when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            populateIpRanges();
            showWelcomeModal();
        });

    </script>
</body>
</html>
